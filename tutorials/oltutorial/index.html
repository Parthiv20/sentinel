
<!DOCTYPE html>
<html>
  <head>
    <title>Sentinel Cloud Analysis</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script>
    <style>
      .ol-dragbox {
        background-color: rgba(255,255,255,0.4);
        border-color: rgb(245, 53, 47);
      }
    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
    <form id="time range">
        enter the date range start date: <input type="date" id="start_date" value="2015-01-01">          end date: <input type="date" id="end_date" value="2017-11-11"> <br>
        <!-- TODO: create drop down for sensor selection -->
        enter the sensor: <input type="text" id="sensor" value = "Sentinel2"> <br>
        enter the cloud detection algorithm: <input type="text" id="algorithm" value = "Fmask"> <br>
        enter the cloud percent limit: <input type="number" id="cloud_percent" value=30> 
    </form> 
      
    <script>

      var map = new ol.Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.BingMaps({
             key: 'AsgRbQKSPoEG6bx_hnkV7Uho58vxclGTOPJWsmg2goDKVG-wVx6iI6eImkGfE_lv',
             imagerySet: 'Aerial',
        })
          })
        ],
        target: 'map',
        view: new ol.View({
          center: [1128023.4148, 7229341.3928],
          zoom: 15
        })
      });

      // a normal select interaction to handle click
      var select = new ol.interaction.Select();
      map.addInteraction(select);

     
      // a DragBox interaction used to select features by drawing boxes
      var dragBox = new ol.interaction.DragBox({
        condition: ol.events.condition.platformModifierKeyOnly
      });

      map.addInteraction(dragBox);

      // triggers when drag box action starts on map
      dragBox.on('boxend', function() {
        var extent = dragBox.getGeometry().getCoordinates();
        var start_date = document.getElementById("start_date").value;
        var end_date = document.getElementById("end_date").value;
        var sensor = document.getElementById("sensor").value.toLowerCase();
        var algorithm = document.getElementById("algorithm").value.toLowerCase();
        var cloud_percent = document.getElementById("cloud_percent").value;
        var in_srs =map.getView().getProjection().getCode(); 
        var params = JSON.stringify({bbox : extent, date_range: [start_date, end_date], satellite: sensor, method: algorithm, cloud_limit : cloud_percent, srs: in_srs })
        
        console.log(extent);
        console.log(start_date);
        console.log(end_date);
        console.log(sensor);
        console.log(algorithm);
        console.log(cloud_percent);
        console.log(in_srs);
        console.log(params);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', "http://localhost:5000/cloud-cover/fmask/sentinel2", false);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.send(params);

      var myData = xhr.responseText;

      console.log(myData);


      // Apeending returned geojsons on basemap.
      var geojsonObject = myData;
      
      var vectorSource = new ol.source.Vector({
        features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
      });

      var vectorLayer = new ol.layer.Vector({
        source: vectorSource
      });
      
      map.addLayer(vectorLayer);
        
      });

      





    </script>
  </body>
</html>