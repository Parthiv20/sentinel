
<!DOCTYPE html>
<html>
  <head>
    <title>Sentinel Cloud Analysis</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.3/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.3/build/ol.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

    <style>
      .ol-dragbox {
        background-color: rgba(255,255,255,0.4);
        border-color: rgb(245, 53, 47);
      }
      #vienna {
        text-decoration: none;
        color:red;
        font-size: 16pt;
        font-weight: bold;
        /* text-shadow: black 0.1em 0.1em 0.2em; */
        padding: 0.2em;
        background-color: rgba(255,255,255,0.3);
        border: 1px solid rgba(255,255,255,0.8);
      }
    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
    <form id="time range">
        enter the date range start date: <input type="date" id="start_date" value="2017-01-01">          end date: <input type="date" id="end_date" value="2017-12-12"> <br>
        <!-- TODO: create drop down for sensor selection -->
        enter the sensor: <input type="text" id="sensor" value = "Sentinel2"> <br>
        enter the cloud detection algorithm: <input type="text" id="algorithm" value = "Fmask"> <br>
        enter the cloud percent limit: <input type="number" id="cloud_percent" value=30> 
    </form> 
    
    <!-- Clickable label for Vienna -->
    <p class="overlay" id="vienna" target="_blank" href="http://en.wikipedia.org/wiki/Vienna"><span style='color:rgb(0, 60, 255);'>2017-05-05</span>, <span style='color:rgb(0, 60, 255);'>2017-06-05</span>, <span style='color:yellow;'>2017-08-05</span>, 2017-11-05, 2017-12-05</p>
               
        
      
    <script>

    var styles = {
      'MultiPolygon': new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: 'red',
          width: 1
        }),
        fill: new ol.style.Fill({
          color: 'rgba(255, 0, 0, 1)'
        })
      }),
      'Polygon': new ol.style.Style({
        stroke: new ol.style.Stroke({
          color:'red',
          width:1
        }),
        fill: new ol.style.Fill({
          color: 'rgba(255, 0, 0, 0.1)'
        }),
        text: new ol.style.Text({
          font: '24px Calibri, sans-serif',
          fil: new ol.style.Fill({color: '#000'}),
          stroke: new ol.style.Stroke({
            color: '#FF0', width:2
          }),
          text: "Spatio-Temporal Short-listing of Images"
        })
      })
    }

    var myStyle = {
      'Polygon': new ol.style.Style({
        stroke: new ol.style.Stroke({
          color:'green',
          width:1
        }),
        fill: new ol.style.Fill({
          color: 'rgba(0, 0, 0, 1)'
        }),
        text: new ol.style.Text({
          font: '16px Calibri, sans-serif',
          fil: new ol.style.Fill({color: '#000'}),
          stroke: new ol.style.Stroke({
            color: '#FFF', width:2
          }),
          text: "Spatio-temporal short listing of images"
        })
      })
    }

    var styleFunction = function(feature){
      return styles[feature.getGeometry().getType()];
    };

    var myStyleFunction = function(feature){
      return myStyle[feature.getGeometry().getType()];
    }




      var map = new ol.Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.BingMaps({
             key: 'AsgRbQKSPoEG6bx_hnkV7Uho58vxclGTOPJWsmg2goDKVG-wVx6iI6eImkGfE_lv',
             imagerySet: 'Aerial',
        })
          })
        ],
        target: 'map',
        view: new ol.View({
          projection: 'EPSG:3857',
          center: [848371.9457, 6791859.3619],
          zoom: 10
        })
      });

      // a normal select interaction to handle click
      var select = new ol.interaction.Select();
      map.addInteraction(select);



      // testing text box
      var pos = [838405.962, 6863745.147];

      // Vienna marker
      var marker = new ol.Overlay({
          position: pos,
          positioning: 'bottom-left',
          element: document.getElementById('vienna'),
          stopEvent: false
      });
      
      


      // a DragBox interaction used to select features by drawing boxes
      var dragBox = new ol.interaction.DragBox({
        condition: ol.events.condition.platformModifierKeyOnly
      });

      map.addInteraction(dragBox);

      // triggers when drag box action starts on map
      dragBox.on('boxend', function() {
        var extent = dragBox.getGeometry().getCoordinates();
        var bbox = dragBox.getGeometry().getExtent();
        var center = [(bbox[0]+bbox[2])/2, (bbox[1]+bbox[3])/2];
        var start_date = document.getElementById("start_date").value;
        var end_date = document.getElementById("end_date").value;
        var sensor = document.getElementById("sensor").value.toLowerCase();
        var algorithm = document.getElementById("algorithm").value.toLowerCase();
        var cloud_percent = document.getElementById("cloud_percent").value;
        var in_srs =map.getView().getProjection().getCode(); 
        var params = JSON.stringify({bbox : extent, date_range: [start_date, end_date], satellite: sensor, method: algorithm, cloud_limit : cloud_percent, srs: in_srs});

        console.log(extent);
        console.log(bbox);
        console.log(center);
        // console.log(start_date);
        // console.log(end_date);
        // console.log(sensor);
        // console.log(algorithm);
        // console.log(cloud_percent);
        // console.log(in_srs);
        // console.log(params);

        var data = {bbox : extent, date_range: [start_date, end_date], satellite: sensor, method: algorithm, cloud_limit : cloud_percent, srs: in_srs};

        $.ajax({
          type: 'POST',
          url: "http://localhost:5000/cloud-cover/fmask/sentinel2",
          // url: "http://localhost:5000/longtask",
          data: JSON.stringify(data, null, '\t'),
          contentType: 'application/json;charset=UTF-8',
          success: function(data, status, request){
            status_url = request.getResponseHeader('Location');
            console.log(status_url);
            update_progress(status_url)
          },
          error:function() {
            alert("Unexpected error");
          }
        })

        var tmp

        function update_progress(status_url){
          $.getJSON(status_url, function(data){
            if (data['result']){
              console.log(data);
              console.log(data['result'])

              var vectorLayerArray = new Array();
              map.getLayers().getArray().some(function(layer,i,array){
                if (layer instanceof ol.layer.Vector){
                  vectorLayerArray.push(layer);
                }
              }, this);
              vectorLayerArray.forEach(function(aVecLayer){
                map.removeLayer(aVecLayer);
              })
              // var geojsonObject = data['current'];
              // var vectorSource = new ol.source.Vector({
              // features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
              // });

              var extent = [838405.962, 6684208.676, 1017845.334, 6863745.147];
                
              var ovProj = ol.proj.get('EPSG:3857');
                
              var rasterLayer = new ol.layer.Image({
                  source: new ol.source.ImageStatic({
                      url: 'file:///C:/Users/pgulla/Desktop/thesis/openeo/webapp/sentinel/app/cloud.png',
                      imageSize:[1848, 1849],
                      projection: ovProj,
                      imageExtent: extent
                  })
              });

              map.removeOverlay(marker);          
              map.addLayer(rasterLayer);

            }
            else {
              if (tmp != data['name']){
                 // retun in 2 seconds
                tmp = data['name'];
                                
                if (data['type'] == 'vector'){
                  var geojsonObject = data['extent'];
                  var vectorSource = new ol.source.Vector({
                      features: (new ol.format.GeoJSON()).readFeatures(geojsonObject)
                  });
                  var vectorLayer = new ol.layer.Vector({
                      source: vectorSource,
                      style: styleFunction
                  });
                  map.addLayer(vectorLayer);
                }
                else if (data['type'] == 'raster'){
                  var img_name = data['name']
                  
                  var extent = data['extent']

                  var ovProj = ol.proj.get('EPSG:3857');

                  var image_size = data['image_size']

                  console.log(image_size)

                  var rasterLayer = new ol.layer.Image({
                      source: new ol.source.ImageStatic({
                          url: 'file:///C:/Users/pgulla/Desktop/thesis/openeo/webapp/sentinel/app/'+img_name,
                          imageSize:image_size,
                          projection: ovProj,
                          imageExtent: extent
                      })
                  });
                          
                  map.addLayer(rasterLayer);
                  map.addOverlay(marker); 
                }  
              }
              else{
              }
              setTimeout(function(){
              update_progress(status_url);
              }, 300);
            }
            
          });
        };
        
      });

      
    </script>
  </body>
</html>